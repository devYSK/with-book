# 21장 로깅과 사용 추적

# 21.1 로그란 무엇인가?

로깅을 하는 이유 

* 접근 통계 (마케팅, 비용, 리소스 사용량, 에러)

보통 트랜잭션의 기본적인 항목들만 로깅한다.

- ﻿﻿HTTP 메서드 - 어떤 행위 
- ﻿﻿클라이언트와 서버의 HTTP 버전 - 클라이언트나 브라우저 문제인지 
- ﻿﻿요청받은 리소스의 URI - 올바른 리소스인지 
- ﻿﻿응답의 HTTP 상태 코드 - 성공인지 실패인지 
- ﻿﻿요청과 웅답 메시지의 크기(모든 엔터티 본문을 포함) - 얼마나 요청이 큰지 계측 

- ﻿﻿트랜잭션이 일어난 시간 - 언제 발생했는지 
- ﻿﻿Referer와 User-Agent 헤더 값 - 유저 추적 

# 21.2 로그 포맷

## 일반 로그 포맷 (Common Log Format)

| 필드          | 설명                                                         |
| ------------- | ------------------------------------------------------------ |
| remotehost    | 요청한 컴퓨터의 호스트 명 혹은 IP 주소. 서버가 리버스 DNS를 수행하게 설정되어 있지 않거나 요청자의 호스트 명을 찾을 수 없으면 IP 주소를 기록. |
| username      | ident 검색을 수행했다면, 인증된 요청자의 사용자 이름.        |
| auth-username | 인증을 수행했다면, 인증된 요청자의 이름.                     |
| timestamp     | 요청 날짜와 시간.                                            |
| request-line  | HTTP 요청의 행을 그대로 기술. 예를 들어 "GET /index.html HTTP/1.1". |
| response-code | 응답으로 보내는 HTTP 상태 코드.                              |
| response-size | 응답 엔터티의 Content-Length. 응답으로 아무런 엔터티도 반환하지 않으면 값이 0이 됨. |

```
192.168.1.1 - john_doe [10/Oct/2023:13:55:36 +0200] "GET /index.html HTTP/1.1" 200 1024
```

* `192.168.1.1`: **remotehost** - 요청자의 IP 주소.
* `-`: **username** - ident 기반의 사용자 이름이 제공되지 않았음을 나타냄.
* `john_doe`: **auth-username** - 인증된 사용자의 이름.
* `[10/Oct/2023:13:55:36 +0200]`: **timestamp** - 요청이 발생한 날짜와 시간.
* `"GET /index.html HTTP/1.1"`: **request-line** - 수행된 HTTP 요청의 세부 사항.
* `200`: **response-code** - HTTP 응답 상태 코드.
* `1024`: **response-size** - 응답된 엔터티의 크기

## 혼합 로그 포맷 

주로 아파치같은 서버가 지원한다.

Referer값과 User-Agent값이 추가되었다.

```
192.168.1.1 - john_doe [10/Oct/2023:13:55:36 +0200] "GET /index.html HTTP/1.1" 200 1024 \
"http://이전페이지.html" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/58.0.3029.110 Safari/537.36"
```

- `"http://example.com/previous_page.html"`: **referer** - 사용자가 이전에 방문한 페이지의 URL.
- `"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"`: **user-agent** - 사용자의 브라우저 및 운영 체제 정보.

### 넷스케이프 확장 로그 포맷

현대의 웹 서버 및 애플리케이션에서는 일반적으로 사용되지 않는다.

현대에는 Apache의 혼합 로그 포맷(Combined Log Format)이나 Nginx의 로그 포맷과 같은 더 표준화된 형식이 널리 사용된다.

# 21.3 적중 계량하기

원 서버는 측정하기 위해 상세 로그를 저장하고 집계한다. (광고 노출여부, 콘텐츠 트래픽량 등)

캐시를 통한다면 원서버로 요청이 가지않아 리소스를 로깅할 수 없다. 캐시를 없애도 트래픽이 늘어 문제가 생긴다.

때문에 Hit Metering 규약을 통해 캐시가 정기적으로 캐시 접근 통계를 원서버에 보고하도록 한다.

## 개요

캐시와 서버가 접근 정보를 공유하고, 사용할 수 있는 캐시 리소스 양을 제어할 수 있는 몇가지 기초적인 기능에 관한 HTTP gㅘㄱ장을 제어한다. 즉 캐시로 성능 향상시키면서 정확한 접근 통게를 제공할 수 있다. 

## Meter 헤더

Meter 헤더에 사용량이나 보고에 관한 지시자를 기술할 수 있다.

그러나 잘 쓰이진 않는다. 일반적으로 필요가 없기 때문이다. 

# 21.4 개인 정보 보호에 대해

나쁜 목적으로 사용하면 안되고, 관리하게 된다면 관리자는 사람들의 트랜잭션을 감시하고 있따는 사실을 공지해야 한다. 