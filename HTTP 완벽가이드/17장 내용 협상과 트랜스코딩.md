# 17장 내용 협상과 트랜스코딩

HTTP의 내용 협상(Content Negotiation)은 클라이언트가 요청하는 리소스의 여러 버전이 서버에 존재할 때 사용되며, 클라이언트의 선호도에 따라 최적의 버전을 제공하는 방법이다.

# 17.1 내용 협상 기법

* 클라이언트 주도 -> 클라이언트가 요청을 보내면 서버는 선택지를 보내주고 클라이언트가 선택 
* 서버 주도 -> 서버가 클라이언트의 헤더를 검증해서 제공 
* 투명 -> 프락시가 서버 대신 협상 

이런 협상 방법들이 있다. 



협상을 위한 헤더 

- `Accept`: MIME 타입에 대한 클라이언트의 선호도를 나타냅니다 (예: `text/html`, `application/json`).
- `Accept-Language`: 클라이언트가 선호하는 언어 (예: `en-us`, `ko-kr`).
- `Accept-Charset`: 문자 인코딩에 대한 선호 (예: `utf-8`, `iso-8859-1`).
- `Accept-Encoding`: 압축 인코딩에 대한 선호 (예: `gzip`, `deflate`).

# 17.2 클라이언트 주도 협상

- 클라이언트가 여러 옵션 중에서 직접 선택할 수 있도록 서버가 다양한 버전의 리소스에 대한 정보를 제공
- 이 방식은 클라이언트가 더 많은 제어권을 가지지만, 추가적인 통신이 필요할 수 있다.

각 페이지에 2번의 요청이 필요하다. 

서버는 어떻게 주는가?

* 여러 버전에 대한 링크와 설명이 담긴 HTML 페이지를 준다
* 300 Multiple Choices 응답 코드로 돌려준다.

때문에 대기시간이 증가하며 최소 두번의 요청이 필요하므로 느리다. 

# 17.3 서버 주도 협상

서버가 클라이언트의 요청 헤더(예: `Accept`, `Accept-Language`, `Accept-Charset`)를 검토하여 가장 적절한 컨텐츠 버전을 선택하여 돌려준다.

이 헤더들은 적절한 헤더 짝이 있다.

| Accept 헤더     | 설명                                                | 매칭되는 엔터티 헤더 |
| --------------- | --------------------------------------------------- | -------------------- |
| Accept          | 서버가 어떤 미디어 타입으로 보내도 되는지 알려준다. | Content-Type         |
| Accept-Language | 서버가 어떤 언어로 보내도 되는지 알려준다.          | Content-Language     |
| Accept-Charset  | 서버가 어떤 문자 집합으로 보내도 되는지 알려준다.   | Content-Type         |
| Accept-Encoding | 서버가 어떤 인코딩으로 보내도 되는지 알려준다.      | Content-Encoding     |

## 그외의헤더

User-Agent와 같은 클라이언트의 다른 헤더를 통해 알맞은 응답도 내려줄 수 있다. 

# 17.4 투명 협상

서버 주도와 클라이언트 주도 협상의 조합으로, 프락시(캐시 서버 등)가 협상 과정에 참여하여 도와준다.

부하도 서버에서 제거할 수 있다. 

이를 위해 Vary 헤더를 이용한다.

서버는 응답에 Vary 헤더를 포함시켜 프락시에게 어떤 헤더를 사용하고있는지 알려줄 수 있다. 

* 클라이언트의 요청 헤더에 따라 콘텐츠가 어떻게 달라질 수 있는지를 명시하며 주로 캐싱 결정에 중요한 역할을 한다

**언어 기반 콘텐츠**:

- 클라이언트가 `Accept-Language` 헤더를 사용하여 특정 언어의 콘텐츠를 요청하는 경우, 서버는 `Vary: Accept-Language` 헤더를 응답에 포함시켜 해당 언어 설정에 따라 콘텐츠가 달라질 수 있음을 나타낸다.

**인코딩 기반 콘텐츠**:

- 클라이언트가 `Accept-Encoding` (예: gzip, deflate)을 사용하여 특정 인코딩의 콘텐츠를 요청하는 경우, 서버는 `Vary: Accept-Encoding` 헤더를 포함시킨다.

> 중요한건 아니다. 요즘은 이렇게 잘 사용 안한다고 한다.



# 17.5 트랜스코딩

서버가 클라이언트의 요구에 맞는 문서를 갖고있지 않다면?

기존의 문서를 클라이언트가 사용할 수 있는 무언가로 변환한다. 이것을 트랜스코딩이라고 한다.

| 전                             | 후                                            |
| ------------------------------ | --------------------------------------------- |
| HTML 문서                      | WNL 문서                                      |
| 고해상도 이미지                | 저해상도 이미지                               |
| 64K색 이미지                   | 흑백 이미지                                   |
| 프레임을 포함한 복잡한 페이지  | 프레임이나 이미지가 없는 단순한 텍스트 페이지 |
| 자바 애플릿이 있는 HTML 페이지 | 자바 애플릿이 없는 페이지                     |
| 광고가 있는 페이지             | 광고가 없는 페이지                            |



트랜스코딩에는 포맷 변환, 정보 합성, 내용 주입의 세 종류가 있다.

* 포맷 변환 : 다른 포맷으로 변환하는것. HTML -> WML 문서. 협상 헤더들에 의해 주도된다
* 정보 합성 : 정보의 요점을 추출하는것을 정보 합성이라고 한다. 제목 기반 개요 생성, 광고 및 로고 제거 등
* 콘텐츠 주입 : 양을 늘리는것을 주입이라고 한다. 광고 생성과 사용자 추적 시스템. 