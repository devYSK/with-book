# 11 이중화 기술

[toc]



# 11.1 이중화 기술 개요

SPOF와 이중화의 목적

## SPof (Single Pint of Failure)

SPof : 단일 장애점

시스템 구성 요소 중 동작하지 않으면 전체 시스템이 중단되는 요소

<img src="./images/11%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%8B%E1%85%B5%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%92%E1%85%AA%20%E1%84%80%E1%85%B5%E1%84%89%E1%85%AE%E1%86%AF//image-20230810231246895.png" width = 400 height = 500>

* 인프라의 다양한 SPof 요소

Spof는 가용성, 연속성, 안정성을 떨어뜨리는 매우 위험한 요소이므로 줄이는것이 아닌 아예 만들어 지지 않도록 설계해야 한다.

## 이중화의 목적

안정적인 서비스 제공을 위해 인프라를 구성하는 각 요소가 복수 개 이상으로 인프라를 구성하여 특정 인프라에 문제가 발생하더라도 이중화된 다른 인프라를 통해 서비스가 지속되도록 하기 위함이다.

* 가상머신서버, 스위치, L4/L7 스위치(로드밸런서), 방화벽, 게이트웨이 등 모든 요소가 이중화 구성에 필요하다
* 데이터 센터 자체도 액티브-액티브 데이터 센터를 구축해야 한다

이중화된 인프라는 장비간 네트워크 연결이나 회선의 대역폭이 증가한다

예를들어 12G 트래픽을 처리해야 하는 경우, 스위치와 서버간 연결이 10G 두개의 네트워크 카드로 액티브-액티브 이중화 되어 있다면 평소에는 부하분산을 통해 6G씩 나눠 처리하지만, 장애가 발생하면 12G의 트래피을 하나의 네트워크 카드로 모두 수용할 수 없게 된다.

그러므로 일부에서 장애가 발생하더라도 서비스에 문제 없도록 용량을 산정해서 설계해야 한다

# LACP

LACP : Link Aggregation Control Protocol

벤더별로 장비간 대역폭을 독자적으로 늘렸을 때 호환성이 안맞으므로, 상호호환 가능한 연결 계층(Link Layer)의 표준

목적

* 링크 사용률 향상
* 향상된 장애 회복

LACP를 사용하면 두 개 이상의 물리 인터페이스로 구성된 논리 인터페이스를 이용해 모든 물리 인터페이스를 액티브-액티브상태로 사용한다

## LACP 동작 방식

장비간 논리 인터페이스를 구성하기 위해 LACPDU(LACP Data Unit) 이라는 프레임을 사용한다

LACP를 구성하기 위한 출발지 주소, 목적지 주소, 타입, 서브타입 버전 정보 등을 매초마다 주고받는다



# 서버의 네트워크 이중화 설정

리눅스 서버 인터페이스 이중화에 사용되는 기술 명칭 : 본드(bond), 본딩(bonding)

| 구분         | 리눅스                                                       |
| ------------ | ------------------------------------------------------------ |
| 기술명       | 본딩                                                         |
| 인터페이스명 | bond 0, bond 1                                               |
| 동작 모드    | 0: 라운드 로빈, 1: 액티브-스탠바이, 2: balance-xor, 3: 브로드캐스트, 4: LACP |

이중화된 인터페이스를 액티브-액티브로 사용할건지, 액티브 - 스탠바이로 사용할것인지만 고려해도 된다 



## 리눅스 본딩 모드

리눅스 본딩 모드는 0~4까지가 있다.

* 액티브 - 스탠바이 : 모드1
* 액티브 - 액티브 : 모드 4

### 모드1 : 액티브 - 스탠바이

평소 액티브 인터페이스로만 패킷이 전달되고, 액티브가 죽으면 스탠바이 인터페이스가 자동으로 활성화 된다

### 모드 4 : LACP

표준 프로토콜인 LACP를 이용해서 인터페이스를 액티브- 액티브 방식으로 사용한다

# 11.4 MC-LAG

MC-LAG (Multi-Chassis Link Aggregation Group)은 두 개 이상의 스위치나 라우터에서 링크 집합을 구성할 수 있는 표준이 아닌 기술

여러 개의 링크를 하나의 논리적 채널로 묶어서 처리하는 기술로, 이로 인해 대역폭이 향상되고, 장애 복구가 빨라지며, 네트워크 구성이 단순화된다.

# 11.5 게이트웨이 이중화

게이트웨이에 장애가 발생하면 외부 네트워크와 통신할 수 없게된다.

<img src="./images/11%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%8B%E1%85%B5%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%92%E1%85%AA%20%E1%84%80%E1%85%B5%E1%84%89%E1%85%AE%E1%86%AF//image-20230810233607820.png" width = 800 height = 600>



게이트웨이 역할을 하는 두대의 장비가 하나의 IP주소를 갖고, 하단 호스트들이 해당 가상 IP와 MAC주소를 알 수 있다면,

위 사진같은 장애가 발생하더라도 통신할 수 있다.

이런 경우에 사용하는 프로토콜이 바로 PHRP(First Hop Redundancy Protocol) 라는 게이트웨이 이중화 프로토콜이다

<img src="./images/11%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%8B%E1%85%B5%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%92%E1%85%AA%20%E1%84%80%E1%85%B5%E1%84%89%E1%85%AE%E1%86%AF//image-20230810233741360.png" width = 400 height = 500>

PHRP를 사용하면 두 라우터는 실제 IP 외에 추가로 가상 IP주소와 가상 IP에 대한 MAC 주소를 동일하게 갖는다.

하단 호스트

* 하단 호스트는 하위에 있는 다른 네트워크 장비들이다 

들이 이 가상 IP를 사용하면, 여러 장비중 ACTIVE 상태를 가진 장비에 문제가 발생하더라도 통신이 끊기지 않으므로 지속적인 통신을 할 수 있다.

## FHRP

FHRP는 외부 네트워크와 통신하기 위해 사용되는 게이트웨이 장비를 두 대 이상의 장비로 구성 할 수 있는 프로토콜.

 FHRP를 이용해 FFIRP 그룹 내의 장비가 동일한 가상 IP를 갖도록 설정하고 FHRP를 설정할 때는 우선순위 값을 이용해 어떤 장비가 가상 IP 주소에 대한 액티브 역할을 할 것인지 결정한다.



**동작 방식**

* FHRP를 구성한 게이트웨이 장비는 동일 그룹으로 인식하기 위해 같은 그룹 ID를 갖도록 설정
  * 동일한 가상IP도 각장비에 설정
* 우선순위 및 역할 결정: 각 라우터는 우선순위를 가지고 있으며, 가장 높은 우선순위를 가진 라우터가 Active 또는 Master 역할을 하고, 나머지 라우터들은 Standby 또는 Backup 역할을 한다.
* 상태 모니터링: 라우터들은 서로의 상태를 지속적으로 모니터링하며, Active 라우터의 장애를 감지하면 Standby 라우터가 자동으로 Active 역할을 수행하게 된다.
* 부하 분산 (일부 프로토콜에서): GLBP와 같은 일부 FHRP는 여러 라우터 간에 트래픽을 분산하여 부하 분산을 수행할 수 있다.
* 하단 호스트가 게이트웨이 가상 IP주소로 ARP 요청을 보내면 FHRP 그룹 장비중 액티브 장비가 요청에 응답하여 통신한다. 

FHRP 기술에 대한 표준 프로토콜은 VRRP(Virtual Router Redundancy Protocl)이다.



## 애니캐스트 게이트웨이

액티브-액티브 게이트웨이는 네트워크가 한 위치에 존재할때 이중화 하는 방식이다.

보다 안정적으로 네트워크를 구성하기 위해 액티브-액티브 게이트웨이와 애니캐스트 게이트웨이를 함께 사용하기도 한다.



### 게이트웨이 고려사항

**가상화 서버 내의 서로 다른 네트워크를 가진 가상 서버 간 통신**

동일한 가상화 서버에 있는 가상 서버 간에도 서로 다른 네트워크를 가지고 있다면 가상화 서버 외부에 있는 게이트웨이를 거쳐야 한다.

<img src="./images/11%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%8B%E1%85%B5%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%92%E1%85%AA%20%E1%84%80%E1%85%B5%E1%84%89%E1%85%AE%E1%86%AF//image-20230810234626487.png" width = 500 height = 400>

**동일한 스위치에 연결된 서로 다른 네트워크를 가진 서버 간 통신(가상화 포함)**

앞의 경우와 비슷하게 동일한 스위치에 구성된 서버 간 통신도 네트워크가 서로 다르면 물리 서버든 가상 서버든 외부에 있는 게이트웨이를 거쳐야 한다.

<img src="./images/11%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%8B%E1%85%B5%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%92%E1%85%AA%20%E1%84%80%E1%85%B5%E1%84%89%E1%85%AE%E1%86%AF//image-20230810234703889.png" width = 500 height  =400>

하지만 최근 네트워크 가상화가 구현된 망에서는 게이트웨이 역할을 가상화 서버 자체의 가상 스위치에서 수행하거나 각 TOR 스위치에서 수행할 수 있도록 해 트래픽이 우회하지 않고 더 빠른 경로로 통신하도록 해주는 기능을 제공하는 경우도 있다.

<img src="./images/11%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%8B%E1%85%B5%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%92%E1%85%AA%20%E1%84%80%E1%85%B5%E1%84%89%E1%85%AE%E1%86%AF//image-20230810234751330.png" width = 900 height = 500>